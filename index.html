<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ファイル情報リストCSV出力ツール</title>
    <link rel="icon" href="favicon16.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe; /* light blue */
            border-color: #0284c7; /* sky blue */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-3xl mx-auto p-4 sm:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-10">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">ファイル情報リストCSV出力ツール</h1>
                <p class="mt-3 text-slate-500">フォルダをドラッグ＆ドロップして、ファイル構成をCSVで書き出します。</p>
            </header>

            <main>
                <!-- ドラッグ＆ドロップエリア -->
                <div id="drop-zone" class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-8 sm:p-12 text-center cursor-pointer bg-slate-50 hover:bg-slate-100">
                    <svg class="mx-auto h-12 w-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    <p class="mt-4 font-semibold text-slate-700">ここにフォルダをドラッグ＆ドロップ</p>
                    <p class="text-sm text-slate-500">またはクリックしてフォルダを選択</p>
                    <input type="file" id="file-input" webkitdirectory directory multiple class="hidden">
                </div>
                
                <!-- 処理結果・設定エリア -->
                <div id="result-area" class="mt-8 hidden fade-in">
                    <div id="status" class="bg-green-100 border border-green-200 text-green-800 rounded-lg p-4 text-center mb-6"></div>
                    
                    <!-- 設定 -->
                    <div class="bg-slate-100/80 p-4 sm:p-6 rounded-lg space-y-6">
                        <h2 class="text-lg font-bold text-slate-800 border-b border-slate-300 pb-2">CSV出力設定</h2>
                        
                        <!-- 出力項目の選択 -->
                        <div>
                            <h3 class="text-md font-semibold text-slate-700 mb-3">出力する列を選択</h3>
                            <div id="column-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                <div><label class="flex items-center"><input type="checkbox" value="name" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">ファイル名</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="nameWithoutExtension" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">ファイル名(拡張子無し)</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="category" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">種類</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="type" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">ファイルの種類(MIME)</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="extension" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">拡張子</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="size" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">サイズ(bytes)</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="lastModified" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">最終更新日時</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="level" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">階層レベル</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="parent" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">親フォルダ</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="fileNumber" class="column-checkbox" checked><span class="ml-2 text-sm text-slate-700">ファイルナンバー（自動割振り）</span></label></div>
                            </div>
                        </div>

                        <!-- 日時フォーマット -->
                        <div id="date-format-section">
                            <h3 class="text-md font-semibold text-slate-700 mb-3">日時フォーマット（複数選択可）</h3>
                            <div id="date-format-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                <div><label class="flex items-center"><input type="checkbox" value="normal" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">日時(結合)</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="date_only" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">日付</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="time_only" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">時刻</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="year" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">年</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="month" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">月</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="day" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">日</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="hour" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">時</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="minute" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">分</span></label></div>
                                <div><label class="flex items-center"><input type="checkbox" value="second" class="date-format-checkbox" checked><span class="ml-2 text-sm text-slate-700">秒</span></label></div>
                            </div>
                        </div>
                        
                        <!-- 並び替え -->
                        <div>
                             <h3 class="text-md font-semibold text-slate-700 mb-3">並び替え</h3>
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="sort-by" class="block text-sm font-medium text-slate-600 mb-1">基準</label>
                                    <select id="sort-by" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                        <option value="none">現状の順 (読み込み順)</option>
                                        <option value="path">パス (階層順)</option>
                                        <option value="name">ファイル名</option>
                                        <option value="size">サイズ</option>
                                        <option value="lastModified">更新日時</option>
                                        <option value="type">ファイルの種類</option>
                                        <option value="extension">拡張子</option>
                                        <option value="category">種類</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sort-order" class="block text-sm font-medium text-slate-600 mb-1">順序</label>
                                    <select id="sort-order" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                        <option value="asc">昇順 (A→Z, 小→大)</option>
                                        <option value="desc">降順 (Z→A, 大→小)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ダウンロードボタン -->
                    <div class="mt-6 text-center">
                        <button id="download-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors duration-200 shadow-md">
                            CSVを生成・ダウンロード
                        </button>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center mt-6 text-sm text-slate-400">
            
        </footer>
    </div>

<script>
// グローバル変数としてファイルリストを保持
let fileDataList = [];
let rootFolderName = 'export';

// DOM要素の取得
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const resultArea = document.getElementById('result-area');
const statusDiv = document.getElementById('status');
const downloadBtn = document.getElementById('download-btn');
const sortBySelect = document.getElementById('sort-by');
const sortOrderSelect = document.getElementById('sort-order');
const lastModifiedCheckbox = document.querySelector('.column-checkbox[value="lastModified"]');
const dateFormatSection = document.getElementById('date-format-section');

// --- チェックボックス連動ロジック ---
lastModifiedCheckbox.addEventListener('change', () => {
    const isChecked = lastModifiedCheckbox.checked;

    // 日時フォーマットセクションの活性/非活性を切り替え
    dateFormatSection.classList.toggle('opacity-50', !isChecked);
    dateFormatSection.classList.toggle('pointer-events-none', !isChecked);
    
    // 「最終更新日時」のチェックが外れたら、日時フォーマットのチェックをすべて外す
    if (!isChecked) {
        const dateFormatCheckboxes = dateFormatSection.querySelectorAll('.date-format-checkbox');
        dateFormatCheckboxes.forEach(cb => {
            cb.checked = false;
        });
    }
});


// --- ドラッグ＆ドロップのイベント設定 ---
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const items = e.dataTransfer.items;
    if (items && items.length > 0) {
        const entry = items[0].webkitGetAsEntry();
        if (entry.isDirectory) {
            rootFolderName = entry.name;
            handleDirectoryEntry(entry);
        } else {
            console.warn('ドロップされたのはフォルダではありません。');
        }
    }
});

fileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
        const firstPath = files[0].webkitRelativePath;
        rootFolderName = firstPath.split('/')[0] || 'export';
        handleFileList(files);
    }
});

// --- ファイル処理ロジック ---
function handleFileList(files) {
    fileDataList = [];
    statusDiv.textContent = 'ファイルを読み込み中...';
    resultArea.classList.remove('hidden');
    Array.from(files).forEach(file => {
        fileDataList.push({
            path: file.webkitRelativePath,
            name: file.name,
            type: file.type || '不明',
            size: file.size,
            lastModified: new Date(file.lastModified),
        });
    });
    updateStatus();
}

async function handleDirectoryEntry(directoryEntry) {
    fileDataList = [];
    statusDiv.textContent = 'フォルダをスキャン中...';
    resultArea.classList.remove('hidden');
    try {
        fileDataList = await traverseDirectory(directoryEntry);
        updateStatus();
    } catch (error) {
        console.error('フォルダのスキャン中にエラーが発生しました:', error);
        statusDiv.textContent = 'エラーが発生しました。コンソールを確認してください。';
        statusDiv.classList.replace('bg-green-100', 'bg-red-100').replace('text-green-800', 'text-red-800');
    }
}

function traverseDirectory(entry) {
    return new Promise((resolve, reject) => {
        let allFiles = [];
        const reader = entry.createReader();
        const readEntries = () => {
            reader.readEntries(async (entries) => {
                if (entries.length === 0) {
                    resolve(allFiles);
                    return;
                }
                const promises = entries.map(subEntry => {
                    if (subEntry.isFile) {
                        return new Promise(resolveFile => {
                            subEntry.file(file => resolveFile({
                                path: subEntry.fullPath.substring(1),
                                name: file.name,
                                type: file.type || '不明',
                                size: file.size,
                                lastModified: new Date(file.lastModified),
                            }));
                        });
                    }
                    return subEntry.isDirectory ? traverseDirectory(subEntry) : Promise.resolve([]);
                });
                const results = await Promise.all(promises);
                allFiles = allFiles.concat(...results.filter(Boolean));
                readEntries();
            }, reject);
        };
        readEntries();
    });
}

function updateStatus() {
    statusDiv.textContent = `${fileDataList.length}個のファイルを読み込みました。`;
}

// 拡張子からファイルの種類を判別する
function getFileCategory(extension) {
    if (!extension) return 'フォルダ/その他';
    const ext = extension.toLowerCase();
    const categories = {
        '画像': ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico', 'tif', 'tiff'],
        '動画': ['mp4', 'mov', 'avi', 'webm', 'mkv', 'flv', 'wmv', 'mpg', 'mpeg'],
        '音声': ['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'],
        'ドキュメント': ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'rtf', 'csv', 'md'],
        '圧縮ファイル': ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'],
        'コード': ['html', 'css', 'js', 'json', 'xml', 'py', 'java', 'c', 'cpp', 'cs', 'php', 'rb', 'go', 'ts'],
        '実行ファイル': ['exe', 'msi', 'dmg', 'app', 'bat', 'sh'],
    };
    for (const category in categories) {
        if (categories[category].includes(ext)) {
            return category;
        }
    }
    return 'その他';
}

// --- CSV生成とダウンロード ---
downloadBtn.addEventListener('click', () => {
    if (fileDataList.length === 0) {
        console.warn('ファイルが読み込まれていません。');
        return;
    }
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');

    // 1. ソート処理
    const sortBy = sortBySelect.value;
    const sortOrder = sortOrderSelect.value;
    let sortedList;

    if (sortBy === 'none') {
        sortedList = [...fileDataList];
    } else if (sortBy === 'path') {
        // --- ▼ここから新しいパス階層ソートのロジック (ファイル優先) ---
        sortedList = [...fileDataList].sort((a, b) => {
            const pathPartsA = a.path.split('/');
            const pathPartsB = b.path.split('/');
            const maxLevel = Math.max(pathPartsA.length, pathPartsB.length);
            const order = sortOrder === 'asc' ? 1 : -1;

            for (let i = 0; i < maxLevel; i++) {
                const partA = pathPartsA[i];
                const partB = pathPartsB[i];

                if (partA === undefined || partB === undefined) {
                    return (pathPartsA.length - pathPartsB.length) * order;
                }

                if (partA !== partB) {
                    const aIsFile = (i === pathPartsA.length - 1);
                    const bIsFile = (i === pathPartsB.length - 1);
                    
                    if (aIsFile && !bIsFile) return -1 * order;
                    if (!aIsFile && bIsFile) return 1 * order;
                    
                    const lowerPartA = partA.toLowerCase();
                    const lowerPartB = partB.toLowerCase();
                    if (lowerPartA < lowerPartB) return -1 * order;
                    if (lowerPartA > lowerPartB) return 1 * order;
                }
            }
            return 0; // Paths are identical
        });
        // --- ▲ここまで ---
    }
    else {
        // 既存のソートロジック
        sortedList = [...fileDataList].sort((a, b) => {
            const getSortValue = (file, key) => {
                const ext = file.name.includes('.') ? file.name.split('.').pop() : '';
                if (key === 'extension') return ext.toLowerCase();
                if (key === 'category') return getFileCategory(ext);
                return file[key];
            }
            let valA = getSortValue(a, sortBy);
            let valB = getSortValue(b, sortBy);

            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
            if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
            return 0;
        });
    }

    // ファイルナンバーを振る
    sortedList.forEach((file, index) => {
        file.fileNumber = index + 1;
    });

    // 2. CSV文字列の生成
    const selectedColumns = Array.from(columnCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => ({
            key: cb.value,
            label: cb.nextElementSibling.textContent
        }));

    // CSVに出力する列の順序を定義
    const outputColumnOrder = ['fileNumber', 'level', 'parent', 'name', 'nameWithoutExtension', 'category', 'type', 'extension', 'size', 'lastModified'];
    const orderedSelectedColumns = selectedColumns.sort((a, b) => {
        return outputColumnOrder.indexOf(a.key) - outputColumnOrder.indexOf(b.key);
    });

    const selectedDateFormats = Array.from(document.querySelectorAll('.date-format-checkbox:checked')).map(cb => cb.value);
    
    // ヘッダーを動的に生成
    const headers = [];
    const dateFormatHeaderMap = {
        'normal': '最終更新日時',
        'date_only': '更新-日付',
        'time_only': '更新-時刻',
        'year': '更新-年',
        'month': '更新-月',
        'day': '更新-日',
        'hour': '更新-時',
        'minute': '更新-分',
        'second': '更新-秒'
    };

    orderedSelectedColumns.forEach(col => {
        if (col.key === 'lastModified') {
            selectedDateFormats.forEach(format => {
                if (dateFormatHeaderMap[format]) {
                    headers.push(dateFormatHeaderMap[format]);
                }
            });
        } else {
            headers.push(col.label);
        }
    });
    const csvRows = [headers.join(',')];

    // 各行のデータを生成
    sortedList.forEach(file => {
        const pathParts = file.path.split('/');
        const fileName = file.name;
        const extension = fileName.includes('.') ? fileName.split('.').pop() : '';
        const nameWithoutExtension = extension ? fileName.slice(0, -(extension.length + 1)) : fileName;
        
        const fileInfo = {
            name: fileName,
            nameWithoutExtension: nameWithoutExtension,
            category: getFileCategory(extension),
            type: file.type,
            extension: extension,
            size: file.size,
            lastModified: file.lastModified,
            level: pathParts.length - 1,
            parent: pathParts.length > 1 ? pathParts.slice(0, -1).join('/') : '(ルート)',
            fileNumber: file.fileNumber,
        };

        const rowData = [];
        orderedSelectedColumns.forEach(col => {
            if (col.key === 'lastModified') {
                const d = fileInfo.lastModified;
                selectedDateFormats.forEach(format => {
                    switch (format) {
                        case 'normal': rowData.push(d.toLocaleString('ja-JP', { hour12: false })); break;
                        case 'date_only': rowData.push(d.toLocaleDateString('ja-JP')); break;
                        case 'time_only': rowData.push(d.toLocaleTimeString('ja-JP', { hour12: false })); break;
                        case 'year': rowData.push(d.getFullYear()); break;
                        case 'month': rowData.push(d.getMonth() + 1); break;
                        case 'day': rowData.push(d.getDate()); break;
                        case 'hour': rowData.push(d.getHours()); break;
                        case 'minute': rowData.push(d.getMinutes()); break;
                        case 'second': rowData.push(d.getSeconds()); break;
                    }
                });
            } else {
                rowData.push(fileInfo[col.key]);
            }
        });

        const escapedRow = rowData.map(field => `"${String(field).replace(/"/g, '""')}"`);
        csvRows.push(escapedRow.join(','));
    });

    const csvContent = csvRows.join('\n');
    
    // 3. ダウンロード処理
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${rootFolderName}_file_list.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
</script>
</body>
</html>


